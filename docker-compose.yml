services:
  # API Gateway
  api-gateway:
    build: ./backend/gateway
    ports:
      - "8000:8000"
    environment:
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - RECIPE_SERVICE_URL=${RECIPE_SERVICE_URL}
      - WORKOUT_SERVICE_URL=${WORKOUT_SERVICE_URL}
      - PAYMENT_SERVICE_URL=${PAYMENT_SERVICE_URL}
      - ANALYTICS_SERVICE_URL=${ANALYTICS_SERVICE_URL}
      - FORUM_SERVICE_URL=${FORUM_SERVICE_URL}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL}
      - PROJECT_NAME=API Gateway
      - VERSION=1.0.0
      - ALLOWED_ORIGINS=["http://localhost:3000","http://localhost:8000"]
      - REQUEST_TIMEOUT=30.0
      - CONNECT_TIMEOUT=5.0
      - MAX_RETRIES=3
    networks:
      - mealup-network

  # Auth Service + Redis
  auth-service:
    build: ./backend/auth-service
    ports:
      - "8001:8001"
    environment:
      - PROJECT_NAME=Auth Service
      - VERSION=1.0.0
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      - AUTH0_REDIRECT_URI=http://localhost:8000/api/v1/auth/callback
      - FRONTEND_URL=http://localhost:3000
      - ALLOWED_ORIGINS=["http://localhost:3000","http://localhost:8000"]
      - REDIS_AUTH_URL=${REDIS_AUTH_URL}
    depends_on:
      auth-redis:
        condition: service_healthy
    networks:
      - mealup-network

  auth-redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${AUTH_REDIS_PASSWORD} --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - auth-redis-data:/data
    networks:
      - mealup-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  shared-postgres-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_MULTIPLE_DATABASES=${POSTGRES_USER_DB},${POSTGRES_PAYMENT_DB},${POSTGRES_FORUM_DB}
    volumes:
      - shared-postgres-data:/var/lib/postgresql/data
      - ./init-postgres.sh:/docker-entrypoint-initdb.d/init-databases.sh
    networks:
      - mealup-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 3s
      retries: 5

  # User Service
  user-service:
    build: ./backend/user-service
    ports:
      - "8002:8002"
    environment:
      - USER_DATABASE_URL=${USER_DATABASE_URL}
    depends_on:
      shared-postgres-db:
        condition: service_healthy
    networks:
      - mealup-network

  # Payment Service
  payment-service:
    build: ./backend/payment-service
    ports:
      - "8005:8005"
    environment:
      - PAYMENT_DATABASE_URL=${PAYMENT_DATABASE_URL}
    depends_on:
      shared-postgres-db:
        condition: service_healthy
    networks:
      - mealup-network

  # Forum Service
  forum-service:
    build: ./backend/forum-service
    ports:
      - "8007:8007"
    environment:
      - FORUM_DATABASE_URL=${FORUM_DATABASE_URL}
    depends_on:
      shared-postgres-db:
        condition: service_healthy
    networks:
      - mealup-network



  shared-mongo-db:
    image: mongo:7
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
    volumes:
      - shared-mongo-data:/data/db
    networks:
      - mealup-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Recipe Service
  recipe-service:
    build: ./backend/recipe-service
    ports:
      - "8003:8003"
    environment:
      - MONGODB_URL=${RECIPE_MONGODB_URL}
    depends_on:
      shared-mongo-db:
        condition: service_healthy
    networks:
      - mealup-network

  # Workout Service
  workout-service:
    build: ./backend/workout-service
    ports:
      - "8004:8004"
    environment:
      - MONGODB_URL=${WORKOUT_MONGODB_URL}
    depends_on:
      shared-mongo-db:
        condition: service_healthy
    networks:
      - mealup-network

  # Analytics Service
  analytics-service:
    build: ./backend/analytics-service
    ports:
      - "8006:8006"
    environment:
      - MONGODB_URL=${ANALYTICS_MONGODB_URL}
    depends_on:
      shared-mongo-db:
        condition: service_healthy
    networks:
      - mealup-network

  # Notification Service + Redis
  notification-service:
    build: ./backend/notification-service
    ports:
      - "8008:8008"
    environment:
      - REDIS_NOT_URL=${REDIS_NOT_URL}
    depends_on:
      notification-redis:
        condition: service_healthy
    networks:
      - mealup-network

  notification-redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${NOTIFICATION_REDIS_PASSWORD} --appendonly yes
    volumes:
      - notification-redis-data:/data
    networks:
      - mealup-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  mealup-network:
    driver: bridge

volumes:
  auth-redis-data:
  shared-postgres-data:
  shared-mongo-data:
  notification-redis-data: